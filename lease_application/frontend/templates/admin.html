<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - System Administration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 30px;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .admin-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #666;
        }
        .admin-tab.active {
            background: #3498db !important;
            color: white !important;
            border-bottom: 3px solid #2980b9 !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3) !important;
        }
        .admin-tab:hover:not(.active) {
            background: #e8f4fd;
            color: #2c3e50;
        }
        .admin-tab.active:hover {
            background: #2980b9;
            color: white;
        }
        .admin-tab-content {
            display: none;
            padding: 30px 0;
        }
        .admin-tab-content.active {
            display: block;
        }
        .admin-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        .admin-section-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .admin-section-header i {
            font-size: 24px;
            opacity: 0.9;
        }
        .admin-section-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .admin-section-body {
            padding: 25px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.07);
        }
        .stat-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: var(--white);
        }
        .stat-icon.total { background-color: var(--blue); }
        .stat-icon.active { background-color: var(--green); }
        .stat-icon.admin { background-color: var(--orange); }
        .stat-info {
            display: flex;
            flex-direction: column;
        }
        .stat-title {
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }
        .notification-form-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .notification-form-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        .template-preview {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #5f6368;
            margin-top: 5px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-grid .form-group {
            margin-bottom: 0;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .admin-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        {% include 'sidebar.html' %}

        <div class="main-content">
            {% include 'header.html' %}
            <div class="page-header">
                <h1><i class="fas fa-cog"></i> System Administration</h1>
                <p>Manage users, system configuration, and automated notifications</p>
            </div>

            <div class="content-area">
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchTab('users')">
                        <i class="fas fa-users"></i> User Management
                    </button>
                    <button class="admin-tab" onclick="switchTab('config')">
                        <i class="fas fa-cogs"></i> System Config
                    </button>
                    <button class="admin-tab" onclick="switchTab('notifications')">
                        <i class="fas fa-bell"></i> Notifications
                    </button>
                </div>
                <!-- User Management Tab -->
                <div id="users-tab" class="admin-tab-content active">
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <i class="fas fa-users"></i>
                            <h3>User Management</h3>
                        </div>
                        <div class="admin-section-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon total">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-title">Total Users</div>
                                        <div class="stat-value" id="totalUsers">0</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon active">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-title">Active Users</div>
                                        <div class="stat-value" id="activeUsers">0</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon admin">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-title">Admin Users</div>
                                        <div class="stat-value" id="adminUsers">0</div>
                                    </div>
                                </div>
                            </div>

                            <div class="leases-table-container">
                                <table class="leases-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Configuration Tab -->
                <div id="config-tab" class="admin-tab-content">
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <i class="fas fa-cogs"></i>
                            <h3>System Configuration</h3>
                        </div>
                        <div class="admin-section-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>SMTP Host</label>
                                    <input id="cfg_smtp_host" type="text" placeholder="smtp.gmail.com">
                                </div>
                                <div class="form-group">
                                    <label>SMTP Port</label>
                                    <input id="cfg_smtp_port" type="number" placeholder="587">
                                </div>
                                <div class="form-group">
                                    <label>SMTP Username</label>
                                    <input id="cfg_smtp_user" type="text" placeholder="user@example.com">
                                </div>
                                <div class="form-group">
                                    <label>SMTP From Address</label>
                                    <input id="cfg_smtp_from" type="text" placeholder="no-reply@example.com">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>SMTP Password</label>
                                    <input id="cfg_smtp_pass" type="password" placeholder="••••••••">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>Gemini API Key</label>
                                    <input id="cfg_gemini_key" type="password" placeholder="AIza...">
                                </div>
                            </div>

                            <div style="margin-top:25px; display:flex; gap:12px;">
                                <button class="btn-primary" onclick="saveConfig()">
                                    <i class="fas fa-save"></i> Save Configuration
                                </button>
                                <button class="btn-secondary" onclick="loadConfig()">
                                    <i class="fas fa-sync"></i> Reload Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div id="notifications-tab" class="admin-tab-content">
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <i class="fas fa-bell"></i>
                            <h3>Notification Settings</h3>
                        </div>
                        <div class="admin-section-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon active">
                                        <i class="fas fa-bell"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-title">Active Rules</div>
                                        <div class="stat-value" id="activeRules">0</div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon total">
                                        <i class="fas fa-list"></i>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-title">Total Rules</div>
                                        <div class="stat-value" id="totalRules">0</div>
                                    </div>
                                </div>
                            </div>

                            <div class="leases-table-container">
                                <table class="leases-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Trigger Event</th>
                                            <th>Days Before</th>
                                            <th>Recipients</th>
                                            <th>Message Preview</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="notificationSettingsTableBody"></tbody>
                                </table>
                            </div>

                            <div class="notification-form-card">
                                <h4><i class="fas fa-plus-circle"></i> Create New Notification Rule</h4>

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Trigger Field</label>
                                        <select id="ns_trigger_field">
                                            <option value="lease_end_date">Lease Expiration</option>
                                            <option value="termination_date">Termination Date</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Days in Advance</label>
                                        <input id="ns_days_advance" type="number" placeholder="30" min="1" value="30">
                                        <small style="color: #666; font-size: 12px;">Send notification this many days before the event</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Recipient Role</label>
                                        <select id="ns_recipient_role">
                                            <option value="user">Regular Users</option>
                                            <option value="reviewer">Reviewers</option>
                                            <option value="admin">Administrators</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Rule Status</label>
                                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                            <input id="ns_is_active" type="checkbox" checked>
                                            <label for="ns_is_active" style="margin: 0; font-weight: normal;">Active</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label>Message Template</label>
                                        <textarea id="ns_message_template" placeholder="Lease {lease_id} expires in {days_in_advance} days." rows="4">Lease {lease_id} expires in {days_in_advance} days. Please review and take necessary action.</textarea>
                                        <div class="template-preview">
                                            <strong>Available variables:</strong> {lease_id}, {days_in_advance}, {company_name}, {asset_title}<br>
                                            <strong>Example:</strong> Lease #123 for ABC Corp expires in 30 days.
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-top:20px; display:flex; gap:12px;">
                                    <button id="ns_save_btn" class="btn-primary" onclick="createNotificationSetting()">
                                        <i class="fas fa-plus"></i> Create Rule
                                    </button>
                                    <button class="btn-secondary" onclick="clearNotificationForm()">
                                        <i class="fas fa-eraser"></i> Clear Form
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);

            // Hide all tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
                console.log('Removed active from:', content.id);
            });

            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Added active to tab content:', tabName + '-tab');
            } else {
                console.error('Tab content not found:', tabName + '-tab');
            }

            // Find and activate the clicked tab button
            const clickedTab = document.querySelector(`button[onclick="switchTab('${tabName}')"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log('Added active to tab button:', tabName);
            } else {
                console.error('Tab button not found for:', tabName);
            }
        }

        // Initialize tabs after admin.js loads
        function initializeTabs() {
            console.log('Initializing tabs...');
            // Only initialize if no tab is currently active
            const activeTabs = document.querySelectorAll('.admin-tab-content.active');
            if (activeTabs.length === 0) {
                console.log('No active tabs found, initializing users tab');
                switchTab('users');
            } else {
                console.log('Active tabs already exist:', activeTabs.length);
            }
        }
    </script>

    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
</body>
</html>
